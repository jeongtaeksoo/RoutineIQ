# QA Report (2026-02-19)

## Phase 0 — Repo Reality Check (Read-Only)

### A. 프로젝트 구조 및 실행 방법 (Confirmed)

#### 앱 구성
- `web`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web` (Next.js 14, App Router)
- `api`: `/Users/taeksoojung/Desktop/RutineIQ/apps/api` (FastAPI)
- `db/migrations`: `/Users/taeksoojung/Desktop/RutineIQ/supabase` (`schema.sql`, `patches/*.sql`)

#### Mobile 코드 존재 여부
- 저장소 내 `apps/mobile`, `ios`, `android`, `expo`, `react-native`, `flutter` 경로 없음.
- 판정: **Mobile code not present in this repo; Web-only changes possible.**

#### 로컬 실행 방법 (README + package scripts 기준)
- API
  - `cd /Users/taeksoojung/Desktop/RutineIQ/apps/api`
  - `python -m venv .venv && source .venv/bin/activate`
  - `pip install -r requirements.txt`
  - `uvicorn app.main:app --reload --port 8000`
- Web
  - `cd /Users/taeksoojung/Desktop/RutineIQ/apps/web`
  - `npm install`
  - `npm run dev` (Next.js `3000`)

#### 테스트/검증 도구
- Web
  - `npm run lint` (Next ESLint)
  - `npm run typecheck` (TypeScript)
  - `npm run build` (Next build)
  - `npm run test:e2e` (Playwright)
- API
  - `python -m pytest tests/ -v --tb=short`
- 통합
  - `./scripts/release-verify.sh` (web lint/typecheck/build/e2e + api checks + smoke)
- CI
  - `/Users/taeksoojung/Desktop/RutineIQ/.github/workflows/ci.yml`
  - API job: ruff + pytest
  - WEB job: lint + typecheck + build

#### API 라우터 등록 위치
- `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/main.py`
- `/api` 하위 라우터: `logs`, `parse`, `analyze`, `reports`, `suggest`, `reflect`, `stripe`, `admin`, `preferences`, `trends`, `insights`, `recovery`

#### Feature Flags (config default)
- 파일: `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/core/config.py`
- 기본값:
  - `RECOVERY_V1_ENABLED=false`
  - `AUTO_LAPSE_ENABLED=false`
  - `RECOVERY_NUDGE_ENABLED=false`
- 동작:
  - `recovery.py`의 `_ensure_enabled/_ensure_auto_lapse_enabled/_ensure_nudge_enabled`에 따라 플래그 OFF 시 관련 엔드포인트는 `404 Not Found` 경로로 차단.

---

### B. As-Is Snapshot (Facts Only)

#### 1) Key Screens (Web)
- `/` 랜딩: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/page.tsx`
- `/login`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/login/page.tsx`
- `/app/insights`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/insights/page.tsx`
- `/app/daily-flow`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/daily-flow/page.tsx`
- `/app/reports/[date]`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/reports/[date]/page.tsx`
- `/app/preferences`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/preferences/page.tsx`
- `/app/billing`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/billing/page.tsx`
- `/admin`: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/admin/page.tsx`

#### 2) Key API Endpoints
- Health: `GET /health`
- Logs: `POST /api/logs`, `GET /api/logs`
- Parse/Analyze/Reports: `POST /api/parse-diary`, `POST /api/analyze`, `GET /api/reports`
- Insights/Trends: `GET /api/insights/weekly`, `GET /api/trends/cohort`, `POST /api/trends/cohort/event`
- Preferences: `GET/PUT /api/preferences/profile`, `DELETE /api/preferences/data`, `DELETE /api/preferences/account`
- Recovery: `/api/recovery/*` (lapse, active, checkin, protocol, action, complete, summary, cron, nudge)
- Stripe: `GET /api/stripe/status`, `POST /api/stripe/create-checkout-session`, `POST /api/stripe/webhook`
- Other AI routes: `POST /api/reflect`, `POST /api/suggest`

#### 3) Known Risk Hotspots (Code-Fact)
- 대형 단일 파일(변경 리스크 높음):
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/analyze.py` (2004 LOC)
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/recovery.py` (1843 LOC)
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/insights/page.tsx` (1534 LOC)
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/daily-flow/page.tsx` (1221 LOC)
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/parse.py` (1195 LOC)
- 인증/권한 경계:
  - Web 앱 게이트: `/Users/taeksoojung/Desktop/RutineIQ/apps/web/src/app/app/layout.tsx` (세션 없으면 `/login` 리다이렉트)
  - API 인증 의존: `AuthDep` 사용 라우트 다수(`logs`, `analyze`, `preferences`, `recovery` 등)
- 데이터 쓰기/외부 의존 집중:
  - Supabase write 경로: `/api/logs`, `/api/preferences/*`, `/api/recovery/*`
  - 외부 연동: Supabase Auth/DB, OpenAI, Stripe

#### 4) Existing Tests Coverage Status (structure-level)
- API 테스트 파일 다수(`apps/api/tests/*`), `def test_` 기준 **156개 테스트 함수** 정의 확인.
- Web E2E 테스트 파일 존재(`apps/web/e2e/*`), Playwright 테스트 케이스 **14개** 정의 확인.
- CI는 API(pytest) + Web(lint/typecheck/build) 자동 실행.
- release gate 스크립트가 Web E2E + API 정적/기본 런타임 검증 + smoke를 수행하도록 구성됨.

---

### Phase 0 결론
- 저장소는 **Web + API 중심의 단일 MVP 코드베이스**이며, 모바일 네이티브 코드는 저장소에 없음.
- 실행/테스트/릴리스 검증 경로가 이미 존재하며, 기능 검증 자동화 기반도 구축되어 있음.
- 다음 단계(Phase 1)는 전체 사용자 기능 인벤토리와 P0 여정 acceptance 기준을 문서화하는 작업으로 진행 가능.

---

## Phase 1 — Output Index

- Feature inventory: `/Users/taeksoojung/Desktop/RutineIQ/docs/FEATURE_INVENTORY.md`
- Critical journeys: `/Users/taeksoojung/Desktop/RutineIQ/docs/E2E_JOURNEYS.md`

---

## Phase 2 — Test Plan & Harness

### A. 생성/업데이트 산출물
- Smoke checklist: `/Users/taeksoojung/Desktop/RutineIQ/docs/SMOKE_TEST_CHECKLIST.md`
- Release checklist: `/Users/taeksoojung/Desktop/RutineIQ/docs/RELEASE_READINESS_CHECKLIST.md`

### B. 테스트 실행 계약(Command Contract)

#### Web quality gates
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/web
npm run lint
npm run typecheck
npm run build
npm run test:e2e
```

#### API quality gate
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/api
.venv/bin/python -m pytest tests/ -v --tb=short
```

#### Release integrated gate
```bash
cd /Users/taeksoojung/Desktop/RutineIQ
./scripts/release-verify.sh
```

### C. 이번 Phase에서 보강한 자동 테스트
- E2E helper 확장:
  - `/api/preferences/profile` `PUT` mock 추가
- 신규 E2E:
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/web/e2e/settings-entrypoints.spec.ts`
    - `/app/preferences` 진입 시 설정 모달(profile 탭) 유도 확인 (mobile + desktop)
    - 설정 패널 데이터 초기화 실행 시 `DELETE /api/preferences/data` 호출 + 성공 피드백 확인

### D. Phase 2 실행 결과 (local)
- `npm run lint` ✅
- `npm run typecheck` ✅
- `npm run build` ✅
- `npm run test:e2e` ✅ (`20 passed`)

---

## Phase 3 — Real Test Execution → Bug Log → Fix Slice

### A. 실테스트 실행 결과

#### 1) API 전체 테스트
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/api
.venv/bin/python -m pytest tests/ -v --tb=short
```
- 결과: ✅ `250 passed` (warnings 8, 실패 0)

#### 2) Web 전체 게이트
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/web
npm run lint
npm run typecheck
npm run build
npm run test:e2e
```
- 결과: ✅ `lint/typecheck/build PASS`, Playwright `20 passed`

#### 3) 통합 릴리스 게이트
```bash
cd /Users/taeksoojung/Desktop/RutineIQ
./scripts/release-verify.sh
```
- 결과: ✅ `PASS`
  - G1 web checks PASS
  - G2 api checks PASS (`mypy` 포함)
  - G3/G4 live smoke PASS (`LIVE_SMOKE_OK`)

### B. 발견된 버그 (실행 중 검출)

- 버그로그: `/Users/taeksoojung/Desktop/RutineIQ/docs/BUGLOG_2026-02-19.md`
- 핵심 이슈:
  - `mypy` 타입 오류 5건 (`recovery.py`, `preferences.py`)

### C. Bug Fix Slice (P1, 최소 수정)

#### 변경 파일
- `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/recovery.py`
- `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/preferences.py`

#### 수정 요약
- 타입 추론 폭이 좁아 발생한 `dict` 타입 충돌을 `dict[str, Any]` 명시로 해결
- 런타임 로직/응답 계약 변경 없음 (정적 타입 안정화)

#### 수정 후 재검증
- `.venv/bin/python -m mypy app` ✅ (`Success: no issues found in 42 source files`)
- `tests/test_preferences_route.py` ✅ (`16 passed`)
- `tests/test_recovery_cron.py` ✅ (`11 passed`)
- 전체 게이트 재실행 결과 모두 PASS

### D. Phase 3 결론
- 실테스트 기반 이슈를 버그로그에 기록하고, 최소 범위로 수정 후 전 게이트 PASS까지 확인 완료.
- 다음 단계(Phase 4)로 진행 가능한 상태.

---

## Phase 4 — Regression Gate & Release Candidate

### A. Full Regression Gate 재실행

#### API
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/api
.venv/bin/python -m pytest tests/ -v --tb=short
```
- 결과: ✅ `250 passed`

#### Web
```bash
cd /Users/taeksoojung/Desktop/RutineIQ/apps/web
npm run lint
npm run typecheck
npm run build
npm run test:e2e
```
- 결과: ✅ `lint/typecheck/build PASS`, Playwright `20 passed`

#### Integrated release gate
```bash
cd /Users/taeksoojung/Desktop/RutineIQ
./scripts/release-verify.sh
```
- 결과: ✅ `[release-verify] PASS`
- 스모크: ✅ `LIVE_SMOKE_OK`

### B. Error-state / Flag-off / Responsive 검증 근거

#### 1) Feature flags OFF 회귀
- 근거 테스트:
  - `tests/test_recovery_route.py::test_recovery_route_returns_404_when_flag_off`
  - `tests/test_recovery_route.py::test_recovery_active_returns_empty_when_flag_off`
  - `tests/test_recovery_route.py::test_recovery_nudge_returns_empty_when_flags_off`
  - `tests/test_recovery_cron.py::test_auto_lapse_and_nudge_are_disabled_when_feature_flags_off`
- 판정: ✅ OFF 경로 회귀 없음

#### 2) 오류 상태 품질
- 401/403 인증 경계:
  - `tests/test_security.py::test_protected_endpoints_require_auth[...]`
  - `tests/test_security.py::test_expired_jwt_returns_401`
  - `tests/test_security.py::test_tampered_jwt_returns_401`
- 404 empty-state:
  - `e2e/core-flows.spec.ts` F2c (`report 404 -> empty-state card`)
  - `tests/test_reports_route.py::test_reports_returns_404_when_missing`
- 5xx/timeout + retry UX:
  - `e2e/core-flows.spec.ts` F2b (`parse-diary 502 -> retry -> success`)
  - `tests/test_parse.py::test_parse_diary_timeout_returns_fallback_response`
- 판정: ✅ 요구 오류 처리 시나리오 통과

#### 3) 반응형/레이아웃 회귀
- 근거 테스트:
  - `e2e/responsive-layouts.spec.ts` (mobile/tablet/desktop)
  - 검증 뷰포트: 390 / 768 / 1440
- 판정: ✅ 겹침/클리핑/레이아웃 붕괴 재현 없음

### C. What Was Fixed in this QA Cycle
- 버그 클러스터 1건(P1) 해결:
  - `mypy` 타입 안정성 오류 5건 해결 (`recovery.py`, `preferences.py`)
- 상세 기록:
  - `/Users/taeksoojung/Desktop/RutineIQ/docs/BUGLOG_2026-02-19.md`

### D. Known Issues / Residual Risk
- Blocker 없음
- 비차단 경고:
  - Playwright 실행 중 Node `NO_COLOR/FORCE_COLOR` 경고
  - 일부 테스트에서 Supabase SDK 보안 권고 warning 로그(`getSession` 안내)
- 운영 영향: 기능 실패를 유발하는 에러는 아님

### E. Launch Confidence & Recommendation
- Confidence: **High**
- Recommendation: **Release Candidate 승인 가능**
- 근거:
  - 전체 API/Web/통합 게이트 반복 PASS
  - 핵심 P0 사용자 여정(E2E) PASS
  - 오류 처리/플래그 OFF/반응형 회귀 검증 PASS
  - 롤백 가능한 최소 변경 단위 유지

### F. Rollback Plan (Release Candidate)
- 대상 변경 범위:
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/recovery.py`
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/api/app/routes/preferences.py`
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/web/e2e/helpers/mock-api.ts`
  - `/Users/taeksoojung/Desktop/RutineIQ/apps/web/e2e/settings-entrypoints.spec.ts`
  - QA 문서 업데이트 파일들
- 장애 시 절차:
  1) 직전 안정 커밋으로 revert
  2) `./scripts/release-verify.sh` 재실행으로 즉시 회귀 확인
  3) 배포 재개 전 BUGLOG에 RCA 추가
